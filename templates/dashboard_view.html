{% extends 'layout.html' %}

{% block title %}Аналітика: {{ account.account_name }} - Social Pro{% endblock %}

{% block content %}
<!-- "Видавлена" картка -->
<div class="bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-700 w-full">
    
    <!-- Заголовок -->
    <div class="mb-6">
        <a href="{{ url_for('dashboard') }}" class="text-sm text-blue-400 hover:underline">&larr; Повернутись до Дашборда</a>
        <h1 class="text-2xl sm:text-3xl font-bold text-white mt-2">
            {{ account.account_name }}
        </h1>
        <p class="text-gray-400">
            <a href="{{ account.url }}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">
                @{{ account.username }}
            </a>
            - 
            <span class="text-sm font-medium bg-blue-800/50 text-blue-300 border border-blue-700 py-0.5 px-2 rounded-full">
                {{ account.platform|title }}
            </span>
        </p>
    </div>

    <!-- Графік -->
    {% if history %}
    <div>
        <h2 class="text-xl font-semibold text-white mb-4">Історія Зростання (Підписники)</h2>
        
        <!-- 
            "Втиснута" картка для графіка:
            - bg-gray-900 (фон)
            - shadow-inner (внутрішня тінь)
        -->
        <div class="bg-gray-900 shadow-inner shadow-black/60 border border-gray-700 rounded-lg p-4">
            <div class="relative w-full h-64 sm:h-96">
                <canvas id="growthChart" 
                        data-url="{{ url_for('get_chart_data', account_id=account.id) }}"
                        data-platform="{{ account.platform }}"
                        role="img" 
                        aria-label="Графік зростання підписників">
                </canvas>
            </div>
        </div>
    </div>
    {% else %}
    <p class="text-gray-500 text-center py-10">
        Даних для побудови графіка ще недостатньо. Зайдіть завтра.
    </p>
    {% endif %}
    
</div>

<!-- 
    *** ОНОВЛЕНИЙ JAVASCRIPT ДЛЯ ТЕМНОГО ДИЗАЙНУ ***
-->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('growthChart');
        if (!canvas) {
            return; 
        }
        
        const chartUrl = canvas.dataset.url;
        const platform = canvas.dataset.platform;
        const metricLabel = (platform === 'telegram') ? 'Підписники' : 'Фоловери';
        const gridColor = 'rgba(107, 114, 128, 0.2)'; // text-gray-500 з прозорістю
        const textColor = '#D1D5DB'; // text-gray-300

        fetch(chartUrl)
            .then(response => response.json())
            .then(data => {
                
                let chartType = 'line';
                if (data.labels.length === 1) {
                    chartType = 'bar';
                }

                new Chart(canvas, {
                    type: chartType, 
                    data: {
                        labels: data.labels, 
                        datasets: [{
                            label: metricLabel,
                            data: data.values, 
                            borderColor: 'rgb(59, 130, 246)', 
                            borderWidth: 3,
                            fill: true,
                            tension: 0.1,
                            backgroundColor: (chartType === 'bar') ? 'rgb(59, 130, 246)' : 'rgba(59, 130, 246, 0.2)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        // --- НОВІ НАЛАШТУВАННЯ ДЛЯ ТЕМНОЇ ТЕМИ ---
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    color: textColor // Колір тексту осі Y
                                },
                                grid: {
                                    color: gridColor // Колір сітки Y
                                }
                            },
                            x: {
                                ticks: {
                                    color: textColor // Колір тексту осі X
                                },
                                grid: {
                                    color: gridColor // Колір сітки X
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            },
                            legend: {
                                display: true,
                                labels: {
                                    color: textColor // Колір тексту легенди
                                }
                            }
                        }
                        // --- КІНЕЦЬ НОВИХ НАЛАШТУВАНЬ ---
                    }
                });
            })
            .catch(error => {
                console.error('Помилка завантаження даних для графіка:', error);
                canvas.parentElement.innerHTML = '<p class="text-red-400 text-center">Не вдалося завантажити графік.</p>';
            });
    });
</script>

{% endblock %}